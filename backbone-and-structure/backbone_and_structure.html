<!DOCTYPE html>
<html>
  <head>
    <title>Backbone skal gi meg struktur, men alt er fortsatt bare rot</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <script src="remark-0.4.4.min.js" type="text/javascript"></script>
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300italic,400|Dosis:300,400|Source+Code+Pro:200,300,400,400bold' rel='stylesheet' type='text/css'>

    <style type="text/css" media="screen">
        h1, h2, h3 { font-family: 'Dosis', sans-serif; }
        h1 { font-weight: 300; font-size: 50px; }
        p, li { font-family: 'Source Sans Pro', sans-serif; font-weight: 300; }
        code { font-family: 'Source Code Pro', sans-serif !important; }
        pre code { background-color: #fff; border-top: 5px solid #ddd; border-bottom: 5px solid #ddd; }
        h1 code { font-weight: 300; font-size: 1em !important; background-color: #eee; padding: 0px 5px; border-radius: 5px; }
        img { max-width: 100%; }
        blockquote { font-style: italic; font-weight: 300; }

        .huge { font-size: 3em; font-family: 'Dosis', sans-serif; }

        .red       { background-color: #E8664E; color: #fff; }
        .green     { background-color: #79A700; color: #fff; }
        .blue      { background-color: #449BB5; color: #fff; }
        .dark-blue { background-color: #043D5D; color: #fff; }
        .yellow    { background-color: #F5E653; color: #fff; }
        .black     { background-color: #000000; color: #fff; }

        .position { display: none; }
  </style>
  </head>
  <body>
    <textarea id="source">

class: middle, center

# Backbone skal gi meg struktur, 
## men alt er fortsatt bare rot

### Fagdag 1.mars 2013

---

class: middle, center

# Hvem er vi?

Kim Joar Bekkelund

Hans Magnus Inderberg

---

class: middle, center

# Hva skal vi snakke om i dag?

Problemstillinger og misforståelser som er lett å gjøre med Backbone.js

---

# Hva er Backbone?

Lite JavaScript-bibliotek på litt mer enn 1000 linjer (6,3kb pakket og gzip-et)

Har blitt svært populært i løpet av de siste årene

&nbsp;

**Mye brukt på prosjekter i BEKK**

---

class: middle

Målet er å gi stuktur ved hjelp av et sett med byggeklosser

*… men Backbone klarer det ikke helt — og derfor er vi her idag!*

---

class: middle, center

# 10 problemer og misforståelser

---

class: middle, center

# \#1

# Hvem har ansvar for hva?

---

# Hvem har ansvar for hva?

Kan fort bli mye som skjer overalt i en stor JavaScript-applikasjon

Det blir vanskelig å få oversikt og det er lett å innføre "bugs"

Backbone har et sett med byggeklosser som skal hjelpe til:

- Modeller
- Collections
- Views
- Router

&nbsp;

** Hver byggekloss har sine spesifikke ansvarsområder **

---

# Model

Databærer som arver fra `Backbone.Model`

Kommuniserer med server ved hjelp av for eksempel ajax

Logikk for å behandle og validere data

** Ingen forståelse eller kjenskap om DOM **

&nbsp;

```javascript
var Transaction = Backbone.Model.extend({
  defaults: {
    from: undefined,
    to: undefined,
    sum: undefined
  }
});

var transaction = new Transaction({
  from: "Gunnar"
  to: "Jens"
  sum: "1500.00"
});

```

---

# Collection

Enkel komponent som har til hensik å holde på en samling av modeller

Inneholder blant annet logikk for å sortere og få et gitt utdrag av modeller

** Ingen forståelse eller kjenskap om DOM **

&nbsp;

```javascript
var Transactions = Backbone.Collection.extend({
    model: Transaction
});

var transactions = new Transactions([transaction1, transaction2]);
```

---

# View

Deles inn i logiske deler som brukeren skal få presentert

Skal ** ikke ** inneholde logikk for endring og manipulering av data

Inneholder logikk for animasjoner og annen jQuery magi

Har ikke lov å gå utover sitt egen DOM element

Kontrollerer alt innenfor sitt DOM element

```javascript
var TransactionsView = Backbone.View.extend({
  events: { ... },
  initialize: function() { ... },
  render: function() { ... }
});

var transactionsView = new TransactionView({ transactions: transactions });
```

## template

Viewene har ansvar for å bygge templates og legge de inn i sitt eget DOM element `$el`

---

# Router

Bestemmer staten til applikasjonen

Lytter på URL endringer

Bytter ut views ved navigering

Sender modeller og collections inn til view'ene

Sørger for å starte hentingen av data'en view'et er avhengig av

```javascript
var Router = Backbone.Router.extend({
  routes: {
    'transactions': 'transactions' 
  },
  transactions: function() {
      var transactions = new Transactions();
      var transactionsView = new TransactionView({ 
        transactions: transactions 
      });
      transactions.fetch();
  }
});
```

---

# Events

Events er en teknikk som kan brukes for kommunikasjon mellom objekter

`Backbone.Events` er en komponent som kan mikses inn i hvilke som helst objekt

Gir komponenten egenskapen å `binde` til events og `trigge` events

Alle komponentene i Backbone bruker events

Store deler av kommunikasjonen i applikasjonen gjøres ved hjelp av events

```javascript
this.model.on(eventNavn, callback, context);

var doSomething = function() {};

this.transactions.on("reset", doSomething, this);
```

Ett event objekt kan brukes for å de-koble forskjellige deler/moduler av applikasjonen 
```javascript
var eventBus = _.clone(Backbone.Events)
```
---

# Hvem har ansvar for hva?

Kommunikasjon

![](images/backbone_structure.png)

---

class: middle, center

# For mye skjer i `initialize`

---

# For mye skjer i `initialize`

```javascript
var UserView = Backbone.View.extend({

    initialize: function() {

        // lager en modell
        var user = new User();

        var self = this;

        // henter data
        user.fetch({

            success: function() {
                // rendrer view når data er mottatt
                self.render();
            }

        });

    }

});
```

<!-- 
Notes:

- Vanskelig å mock bort user
- Starter ajaxkallet når man new'er opp objektet, så hver gang noen sier new UserView vil det automagisk gå ett ajax request
- Kaller render fra initialize via callbacket til success

-->

---

# For mye skjer i `initialize`

Viewet skal helst ikke hente sin egen data, det skal få data

Viewet skal respondere på data-endringer

```javascript
var UserView = Backbone.View.extend({

    initialize: function(options) {
        this.user = options.user;
        this.user.on('change', this.render, this);
    }

});

var user = new User();
var userView = new UserView({ user: user });
user.fetch();
```

---

class: middle, center

# For mye logikk i viewene

---

# For mye logikk i viewene

Her er et eksempel på en model `Transaction` og en collection `Transactions`

Vi skal lage et view som presenterer en liste med `Transactions`

```javascript
var Transaction = Backbone.Model.extend({
    defaults: {
        sum: undefined,
        from: undefined,
        to: undefined,
        createdAt: undefined,
        type: undefined
    }
});

var Transactions = Backbone.Collection.extend({
    model: Transaction
});
```

---

# For mye logikk i viewene

```javascript
var TransactionsView = Backbone.View.extend({
    initialize: function(options) {
        this.transactions = options.transactions;
    },
    render: function() {
        var sortedTransactions = this.transactions.sortBy(
          function(transaction) {
            var timestamp = Date.parse(transaction.get('createdAt')) * 1000;
            if (transaction.get("type") === transactionType.ONE_TYPE) {
                timestamp += "B";
            } else if (transaction.get("type") === 
              transactionType.ANOTHER_TYPE) {
                timestamp += "A";
            } 

            return timestamp;
        });
        var json = _.map(sortedTransactions, function(transaction){ 
          return transaction.toJSON(); 
        });
        this.$el.html(transactionsTemplate(json));
        return this;
    }
});
```

---

# For mye logikk i viewene

Flytt logikk til `model` og `collection`:

```javascript
var TransactionsView = Backbone.View.extend({

    initialize: function(options) {
        this.transactions = options.transaction;
    },

    render: function() {
        var json = this.transactions.
          getTransactionsSortedByDateAndType().toJSON();

        this.$el.html(transactionsTemplate(json));

        return this;
    }

});
```

---

class: middle, center

Kim tar over

# View'ene mine blir alt for store

---

class: middle, center

![](images/store-views.png)

---

class: middle, center

![](images/store-views2.png)

---

# View'ene mine blir alt for store

Starter alltid små

… men de vokser og vokser

… og blir mer og mer komplekse

… og det blir vanskelig å få oversikt

… og det blir vanskelig å teste dem

---

# Hvilken modell skal brukes?

```javascript
var ProductsView = Backbone.View.extend({

    events: {
        'click .choose': 'chooseProduct'
    },

    initialize: function(options) {
        this.products = options.products;
        this.products.on('reset', this.render, this);
    },

    render: function() {
        // masse kode her
    },

    chooseProduct: function(e) {
        e.preventDefault();
        // her må vi lete rundt i DOM-en
        var productId = $(e.target).attr('data-product-id');
        var product = this.products.get(productId);
        product.doSomething();
    }

});
```

---

class: middle, center

Løsningen? Del viewet inn i **subviews**!

---

class: middle, center

Bildet med markering på hvor viewene er

---

# Et view per model i en collection?

```javascript
var ProductsView = Backbone.View.extend({

    initialize: function(options) {
        this.products = options.products;
        this.products.on('reset', this.render, this);
    },

    render: function() {
        this.renderTemplate(); // hjelpemetode for å rendre viewet

        this.products.each(function(product) {
            var productView = new ProductView({ product: product });
            this.$('.products').append(productView.render().el);
        }, this);

        return this;
    }

});
```

---

# Et view per model i en collection?

Nå kan `ProductView` gjøres veldig enkel:

```javascript
var ProductView = Backbone.View.extend({

    tagName: 'li',

    events: {
        'click .choose': 'chooseProduct'
    },

    initialize: function(options) {
        this.product = options.product;
    },

    chooseProduct: function(e) {
        e.preventDefault();
        this.product.doSomething();
    }

});
```

---

# Fordel ansvar

```javascript
var PersonView = Backbone.View.extend({});
var AddressView = Backbone.View.extend({});

var PersonalInformationView = Backbone.View.extend({

    initialize: function(options) {
        this.addressView = new AddressView({ address: options.address });
        this.personView = new PersonView({ person: options.person });
    },

    render: function() {
        this.renderTemplate();

        this.personView.setElement(this.$('.person'));
        this.personView.render();

        this.addressView.setElement(this.$('.address'));
        this.addressView.render();

        return this;
    }
});
```

---

class: middle, center

# Jeg repeterer samme kode overalt

---

# Jeg repeterer samme kode overalt

Slik ser ofte `render` ut:

```javascript
var UserView = Backbone.View.extend({

    render: function() {
        var data = this.user.toJSON();
        this.$el.html(Mustache.to_html(this.template, data));
        return this;
    }

});
```

Denne ser ofte helt lik ut:

```javascript
this.$el.html(Mustache.to_html(this.template, data));
```

Er ikke dette bedre?

```javascript
this.renderTemplate(data);
```

---

# Jeg repeterer samme kode overalt

Kan bruke arv og lage et delt `BaseView`:

```javascript
var BaseView = Backbone.View.extend({

    renderTemplate: function(data) {
        this.$el.html(Mustache.to_html(this.template, data));
        return this;
    }

});
```

Nå lager vi nye views fra `BaseView`:

```javascript
var UserView = BaseView.extend({

    this.render: function() {
        return this.renderTemplate(this.user.toJSON());
    }

});
```

---

# Jeg repeterer samme kode overalt

Og det er veldig enkelt å legge til litt ekstra funksjonalitet:

```javascript
var UserView = BaseView.extend({

    this.render: function() {
        return this.renderTemplate(this.user.toJSON(), {
            company: 'BEKK',
            is: 'the best'
        });
    }

});
```

---

class: middle, center

# Det er viktig at det bare finnes én

---

# Det er viktig at det bare finnes én

Vi har en handlekurv for app-en:

```javascript
var Cart = Backbone.Model.extend({
    url: '/api/cart'
});

```

---

# Det er viktig at det bare finnes én

Vi har en handlekurv for app-en:

```javascript
var Cart = Backbone.Model.extend({
    url: '/api/cart'
});

```

Vi lager en instans for handlekurv-siden

```javascript
var cart = new Cart();
var cartView = new CartView({ cart: cart });
```

---

# Det er viktig at det bare finnes én

Vi har en handlekurv for app-en:

```javascript
var Cart = Backbone.Model.extend({
    url: '/api/cart'
});

```

Vi lager en instans for handlekurv-siden

```javascript
var cart = new Cart();
var cartView = new CartView({ cart: cart });
```

Og en instans for menyen

```javascript
var cart = new Cart();
var menuView = new MenuView({ cart: cart });
```

---

# Det er viktig at det bare finnes én

Vi har en handlekurv for app-en:

```javascript
var Cart = Backbone.Model.extend({
    url: '/api/cart'
});

```

Vi lager en instans for handlekurv-siden

```javascript
var cart = new Cart();
var cartView = new CartView({ cart: cart });
```

Og en instans for menyen

```javascript
var cart = new Cart();
var menuView = new MenuView({ cart: cart });
```

Hva skjer nå?

```javascript
cart.add({ ... })
```

---

# Det er viktig at det bare finnes én

En mulig løsning når man bruker Require.js:

```javascript
define(['Backbone'], function(Backbone) {

    var Cart = Backbone.Model.extend({
        url: '/api/cart'
    });

    return new Cart();

});
```

---

# Det er viktig at det bare finnes én

En mulig løsning når man bruker Require.js:

```javascript
define(['Backbone'], function(Backbone) {

    var Cart = Backbone.Model.extend({
        url: '/api/cart'
    });

    return new Cart();

});
```

Vi returnerer en *singleton*

Nå vet vi at det bare finnes én

---

# Det er viktig at det bare finnes én

En mulig løsning når man bruker Require.js:

```javascript
define(['Backbone'], function(Backbone) {

    var Cart = Backbone.Model.extend({
        url: '/api/cart'
    });

    return new Cart();

});
```

Vi returnerer en *singleton*

Nå vet vi at det bare finnes én

… men pass på: blir fort store, med for mye tilstand og liten testbarhet

---

# Det er viktig at det bare finnes én

En mulig løsning når man bruker Require.js:

```javascript
define(['Backbone'], function(Backbone) {

    var Cart = Backbone.Model.extend({
        url: '/api/cart'
    });

    return new Cart();

});
```

Vi returnerer en *singleton*

Nå vet vi at det bare finnes én

… men pass på: blir fort store, med for mye tilstand og liten testbarhet

Send den helst inn som en avhengighet til views

---

class: middle, center

# Backbone-plugins = jQuery-plugins

---

# Backbone-plugins = jQuery-plugins

Shitty kvalitet på det meste

Ikke dra inn for store plugins for tidlig — forstå verdien de tilfører

Mange plugins tar over kode som ligger på `Backbone`

Eksempel fra `Backbone.localStorage`:

```javascript
// Override 'Backbone.sync' to default to localSync,
// the original 'Backbone.sync' is still available in 'Backbone.ajaxSync'

Backbone.sync = function(method, model, options) {
    return Backbone.getSyncMethod(model).apply(this, [method, model, options]);
};
```

---

# Backbone-plugins = jQuery-plugins

Sjekk kodekvaliteten på pluginen du ønsker å dra inn

Lett å dra inn — potensielt masse kompleksitet

Ikke gjør applikasjonen din for avhengig, utvikling på pluginen kan plutselig slutte

Plugins kan magisk, men husk at magien blir fort ødelagt

---

class: middle, center

Husk Hollywood-prinsippet:

.huge[Don't call me, I'll call you]

---

# Trenger du egentlig denne plugin-en?

Backbone-relational er for eksempel større enn Backbone selv

---

# Trenger du egentlig denne plugin-en?

Backbone-relational er for eksempel større enn Backbone selv

Du trenger én-til-mange-relasjon?

---

# Trenger du egentlig denne plugin-en?

Backbone-relational er for eksempel større enn Backbone selv

Du trenger én-til-mange-relasjon?

    .javascript
    var Inbox = Backbone.Model.extend({

      initialize: function() {
        this.messages = new Messages();
      },

      parse: function(resp) {
        this.messages.update(_.clone(resp.messages), { parse: true });
        delete resp.messages;
        return resp;
      },

      toJSON: function() {
        var json = _.clone(this.attributes);
        json.messages = this.messages.toJSON();
        return json;
      }

    });


---

class: middle, center

# Backbone brukes der det ikke trengs

---

# Backbone brukes der det ikke trengs

!! Komponenter

Komponenter som vi har valgt å kalle dem er et forsøk på å bidra til å gjøre plugins mer håndterbare

De skal vœre små

Løse enkle problemer

Hindre duplisering av kode

Backbone modeller og collections brukes der man trenger å hente data

Views brukes til å vise dataen

Alle komponentene rundt trenger ikke vœre knyttet til rammeverket

Komponenter skal vœre lette, løse små problemer og ha få avhengigheter

Vi vil gå igjennom noen eksempler på komponenter

---

class: middle, center

# Filer ligger overalt

Require.js?

---

# Filer ligger overalt

Kan virke banalt, men det er utrolig viktig

Mappestruktur. Ikke lag egne views, models og collections mapper. Samle moduler
i egen mappe. Dette gjør det faktisk enklere å få rask oversikt over hva app-en
gjør (se på mappenavnene i modules-mappa)

- component
- module
- external

Eller?

- model
- collections
- views
- router
- external

Tilhørlighet

---

# Filer ligger overalt

```sh
$ tree
.
├── app.js
├── components
│   ├── subViewHandler.js
│   └── validation.js
├── index.html
├── libs
│   ├── backbone-0.9.10.js
│   ├── jquery-1.9.1.js
│   └── underscore-1.4.4.js
└── modules
    └── payments
        ├── payment.js
        ├── payment.mustache
        ├── paymentView.js
        └── payments.js

4 directories, 11 files
```

---

# Filer ligger overalt

Require.js-eksempel. Trenger ikke lengre "full path".

---

class: middle, center

# Huskeliste

---

# Huskeliste

Testbarhet ≈ struktur

Ny i kodebasen

Når man er ny i en kodebase, selv med god kjennskap til rammeverkene, møter man nye måter å bruke rammeverkene på

Følg rammeverket man har valgt og ikke kjemp mot det

En annen viktig ting kan vœre å hele tiden tenke på at det kommer en etter deg

```javascript
var Transaction = Backbone.Model.extend({});
```

vs

```javascript
var Transaction = Backbone.Model.extend({
    defaults: {
        sum: undefined,
        from: undefined,
        to: undefined,
        createdAt: undefined,
        type: undefined
    }
});

Ikke gjør for masse magi

Gjør det enkelt og forståelig

Ha en overordnet "filosofi"

---

class: middle, center, black

# Spørsmål?

# Uenig?

    </textarea>
    <div id="slideshow"></div>
  </body>
</html>
